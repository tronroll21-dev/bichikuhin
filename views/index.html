<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>備蓄品管理システム</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
</head>
<body class="bg-gray-100" x-data="stockManager()">

    <nav class="print:hidden bg-white shadow-md">
        <div class="max-w-6xl mx-auto px-4">
            <div class="flex justify-between">
                <div class="flex space-x-4">
                    <div>
                        <a href="/" class="flex items-center py-5 px-2 text-gray-700 hover:text-gray-900">
                            <span class="font-bold">備蓄品一覧表</span>
                        </a>
                    </div>
                </div>
                <div class="flex items-center space-x-1">
                    <div x-data="{ showMenu: false }" class="relative">
                        <button @click="showMenu = !showMenu" class="flex items-center justify-center w-10 h-10 bg-blue-500 text-white rounded-full">
                            <span x-text="user.name_jp ? user.name_jp.charAt(0) : user.name.charAt(0).toUpperCase()"></span>
                        </button>
                        <div x-show="showMenu" @click.away="showMenu = false" class="absolute right-0 mt-2 py-2 w-48 bg-white rounded-md shadow-xl z-20">
                            <a href="/change_password" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">パスワード変更</a>
                            <a href="#" @click.prevent="logout()" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">ログアウト</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-screen-2xl mx-auto p-8 flex space-x-6">
        <!-- Left Sidebar: Stocktaking List -->
        <div class="w-1/4 print:hidden">
            <div class="bg-white p-4 rounded shadow flex flex-col" style="height: calc(100vh - 100px);">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">棚卸一覧</h2>
                    <button @click="openNewStocktakingForm()" class="w-8 h-8 bg-green-500 text-white rounded-full flex items-center justify-center hover:bg-green-600">
                        <span class="font-bold text-xl">+</span>
                    </button>
                </div>

                <!-- New Stocktaking Form -->
                <div x-show="showNewStocktakingForm" class="mb-4 p-4 bg-gray-50 rounded">
                    <h3 class="font-bold mb-2">新規棚卸</h3>
                    <input type="text" x-model="newStocktaking.name" class="border p-2 rounded w-full mb-2">
                    <input type="date" x-model="newStocktaking.date" class="border p-2 rounded w-full mb-2">
                    <div class="flex justify-end space-x-2">
                        <button @click="cancelNewStocktaking" class="bg-gray-300 px-3 py-1 rounded">x</button>
                        <button @click="saveStocktaking" class="bg-blue-600 text-white px-3 py-1 rounded">✓</button>
                    </div>
                </div>

                <ul class="overflow-y-auto flex-grow">
                    <template x-for="stocktaking in stocktakings" :key="stocktaking.id">
                        <li @click="selectStocktaking(stocktaking.id)"
                            :class="{ 'bg-blue-100': selectedStocktakingId === stocktaking.id }"
                            class="p-3 hover:bg-gray-100 cursor-pointer rounded">
                            <div class="flex justify-between items-center">
                                <span class="font-semibold" x-text="stocktaking.name"></span>
                                <template x-if="stocktaking.active">
                                    <span class="bg-green-500 text-white text-xs font-semibold px-2 py-1 rounded-full">現</span>
                                </template>
                            </div>
                            <div class="text-sm text-gray-600" x-text="formatDate(stocktaking.date, { year: 'numeric', month: 'long', day: 'numeric' })"></div>
                        </li>
                    </template>
                </ul>
            </div>
        </div>

        <!-- Right Content: Stock Records -->
        <div class="print:w-full w-3/4 flex flex-col" style="height: calc(100vh - 100px);">
            <div class="print:hidden bg-white p-4 rounded shadow mb-6 flex-shrink-0">
                <div class="grid grid-cols-6 gap-4">
                    <div class="relative">
                        <input type="text" x-model="bichikuhinName" @input.debounce.300ms="searchBichikuhin" @keydown.enter.prevent="handleBichikuhinEnter" placeholder="備蓄品名" class="border p-2 rounded w-full">
                        <div x-show="showBichikuhinSuggestions" @click.away="showBichikuhinSuggestions = false" class="absolute z-10 w-full bg-white border rounded mt-1">
                            <ul>
                                <template x-for="item in bichikuhinSuggestions" :key="item.id">
                                    <li @click="selectBichikuhin(item)" class="p-2 hover:bg-gray-100 cursor-pointer" x-text="item.name"></li>
                                </template>
                            </ul>
                        </div>
                    </div>
                    <select x-model="form.locationId" class="border p-2 rounded">
                        <option value="">保管場所を選択</option>
                        <template x-for="loc in masters.locations">
                            <option :value="loc.id" x-text="loc.name"></option>
                        </template>
                    </select>
                    <input type="number" x-model="form.quantity" placeholder="数量" class="border p-2 rounded">
                    <select x-model="form.unitId" class="border p-2 rounded">
                        <option value="">単位を選択</option>
                        <template x-for="unit in masters.units">
                            <option :value="unit.id" x-text="unit.name"></option>
                        </template>
                    </select>
                    <input type="date" x-model="form.expiryDate" class="border p-2 rounded">
                    <button @click="saveRecord()" :disabled="!selectedStocktakingId" class="bg-blue-600 text-white px-4 py-2 rounded disabled:bg-gray-400">保存</button>
                </div>
            </div>

            <div class="flex-grow overflow-y-auto print:overflow-y-visible bg-white rounded shadow">
                <table class="min-w-full">
                    <thead>
                        <tr class="bg-gray-200 text-left sticky top-0">
                            <th class="p-3">登録日時</th>
                            <th class="p-3">品名</th>
                            <th class="p-3">場所</th>
                            <th class="p-3">数量</th>
                            <th class="p-3">消費期限</th>
                            <th class="p-3 print:hidden">操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="record in records" :key="record.id">
                            <tr class.bind="'border-t ' + (editingRecordId === record.id ? 'bg-yellow-50' : 'hover:bg-gray-50 cursor-pointer')"
                                @click="editingRecordId !== record.id ? startEditing(record) : null">
                                
                                <td class="p-3" x-text="formatDate(record.entry_timestamp)"></td>
                                
                                <td class="p-3">
                                    <template x-if="editingRecordId !== record.id">
                                        <span x-text="record.Bichikuhin?.name"></span>
                                    </template>
                                    <template x-if="editingRecordId === record.id">
                                        <input type="text" x-model="editFormData.Bichikuhin.name" @click.stop class="border p-1 rounded w-full">
                                    </template>
                                </td>
                                
                                <td class="p-3">
                                    <template x-if="editingRecordId !== record.id">
                                        <span x-text="record.StorageLocation?.name"></span>
                                    </template>
                                    <template x-if="editingRecordId === record.id">
                                        <select x-model="editFormData.StorageLocationId" @click.stop class="border p-1 rounded w-full">
                                            <template x-for="loc in masters.locations">
                                                <option :value="loc.id" x-text="loc.name"></option>
                                            </template>
                                        </select>
                                    </template>
                                </td>
                                
                                <td class="p-3">
                                    <template x-if="editingRecordId !== record.id">
                                        <span x-text="`${record.quantity} ${record.Unit?.name}`"></span>
                                    </template>
                                    <template x-if="editingRecordId === record.id">
                                        <div class="flex items-center space-x-2">
                                            <input type="number" x-model="editFormData.quantity" @click.stop class="border p-1 rounded w-20">
                                            <select x-model="editFormData.UnitId" @click.stop class="border p-1 rounded">
                                                <template x-for="unit in masters.units">
                                                    <option :value="unit.id" x-text="unit.name"></option>
                                                </template>
                                            </select>
                                        </div>
                                    </template>
                                </td>
                                
                                <td class="p-3">
                                    <template x-if="editingRecordId !== record.id">
                                        <span x-text="record.expiry_date"></span>
                                    </template>
                                    <template x-if="editingRecordId === record.id">
                                        <input type="date" x-model="editFormData.expiry_date" @click.stop class="border p-1 rounded w-full">
                                    </template>
                                </td>

                                <td class="p-3 print:hidden">
                                    <template x-if="editingRecordId === record.id">
                                        <div class="flex space-x-2">
                                            <button @click.stop="saveEdit()" class="bg-green-500 text-white px-3 py-1 rounded">保存</button>
                                            <button @click.stop="cancelEdit()" class="bg-gray-500 text-white px-3 py-1 rounded">キャンセル</button>
                                        </div>
                                    </template>
                                    <template x-if="editingRecordId !== record.id">
                                        <button @click.stop="startEditing(record)" class="text-blue-500 underline">編集</button>
                                    </template>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        function stockManager() {
            return {
                records: [],
                masters: { locations: [], units: [] },
                stocktakings: [],
                selectedStocktakingId: null,
                form: { id: null, bichikuhinId: '', locationId: '', quantity: 0, expiryDate: '', unitId: '', stocktakingId: null },
                user: { name: '' },
                showMenu: false,
                bichikuhinName: '',
                bichikuhinSuggestions: [],
                showBichikuhinSuggestions: false,
                showNewStocktakingForm: false,
                newStocktaking: { name: '', date: '' },
                editingRecordId: null,
                editFormData: {},

                getTodayDateString() {
                    const today = new Date();
                    const yyyy = today.getFullYear();
                    const mm = String(today.getMonth() + 1).padStart(2, '0');
                    const dd = String(today.getDate()).padStart(2, '0');
                    return `${yyyy}-${mm}-${dd}`;
                },

                async init() {
                    await this.fetchUser();
                    await this.fetchMasters();
                    await this.fetchStocktakings();
                    if (this.stocktakings.length > 0) {
                        this.selectStocktaking(this.stocktakings[0].id);
                    }
                    this.resetForm();
                },

                async apiFetch(url, options = {}) {
                    let response = await fetch(url, options);
                    if (response.status === 401) {
                        const refreshRes = await fetch('/api/refresh', { method: 'POST' });
                        if (refreshRes.ok) {
                            return fetch(url, options);
                        } else {
                            window.location.href = '/login';
                        }
                    }
                    return response;
                },

                async fetchUser() {
                    const res = await this.apiFetch('/api/user');
                    this.user = await res.json();
                },

                async fetchStocktakings() {
                    const res = await this.apiFetch('/api/stocktakings');
                    this.stocktakings = await res.json();
                },

                async fetchData(stocktakingId) {
                    if (!stocktakingId) {
                        this.records = [];
                        return;
                    }
                    const res = await this.apiFetch(`/api/records/${stocktakingId}`);
                    this.records = await res.json();
                },
                
                selectStocktaking(id) {
                    this.selectedStocktakingId = id;
                    this.fetchData(id);
                    this.showNewStocktakingForm = false; // Hide form on selection change
                    this.resetForm();
                },

                async fetchMasters() {
                    const res = await this.apiFetch('/api/masters');
                    const data = await res.json();
                    this.masters.locations = data.locations;
                    this.masters.units = data.units;
                },
                
                openNewStocktakingForm() {
                    const today = this.getTodayDateString();
                    this.newStocktaking.date = today;
                    this.newStocktaking.name = `棚卸${today}`;
                    this.showNewStocktakingForm = true;
                },

                cancelNewStocktaking() {
                    this.showNewStocktakingForm = false;
                    this.newStocktaking = { name: '', date: '' };
                },

                async saveStocktaking() {
                    const res = await this.apiFetch('/api/stocktakings', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(this.newStocktaking)
                    });

                    if (res.ok) {
                        const savedStocktaking = await res.json();
                        await this.fetchStocktakings(); // Refresh the list
                        this.selectStocktaking(savedStocktaking.id); // Select the new one
                        this.cancelNewStocktaking(); // Hide and reset the form
                    } else {
                        alert('棚卸の保存に失敗しました。');
                    }
                },

                async searchBichikuhin() {
                    if (this.bichikuhinName.length < 2) {
                        this.showBichikuhinSuggestions = false;
                        return;
                    }
                    const res = await this.apiFetch(`/api/bichikuhin?name=${this.bichikuhinName}`);
                    this.bichikuhinSuggestions = await res.json();
                    this.showBichikuhinSuggestions = true;
                },

                selectBichikuhin(item) {
                    this.bichikuhinName = item.name;
                    this.form.bichikuhinId = item.id;
                    this.showBichikuhinSuggestions = false;
                },

                async handleBichikuhinEnter() {
                    if (this.bichikuhinSuggestions.length === 1 && this.bichikuhinSuggestions[0].name === this.bichikuhinName) {
                        this.selectBichikuhin(this.bichikuhinSuggestions[0]);
                    } else {
                        const found = this.bichikuhinSuggestions.find(item => item.name === this.bichikuhinName);
                        if (!found) {
                            if (confirm(`'${this.bichikuhinName}' は新しい備蓄品です。登録しますか？`)) {
                                await this.addNewBichikuhin(this.bichikuhinName);
                            }
                        }
                    }
                },
                
                async addNewBichikuhin(name) {
                    const res = await this.apiFetch('/api/bichikuhin', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name: name })
                    });
                    if (res.ok) {
                        const newItem = await res.json();
                        this.selectBichikuhin(newItem);
                    } else {
                        alert('備蓄品の登録に失敗しました。');
                    }
                },

                async saveRecord() {
                    if (!this.selectedStocktakingId) {
                        alert('まず棚卸を選択してください。');
                        return;
                    }
                    this.form.stocktakingId = this.selectedStocktakingId;
                    
                    const method = this.form.id ? 'PUT' : 'POST';
                    await this.apiFetch('/api/records', {
                        method: method,
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(this.form)
                    });
                    this.resetForm();
                    this.fetchData(this.selectedStocktakingId);
                },

                startEditing(record) {
                    this.editingRecordId = record.id;
                    this.editFormData = JSON.parse(JSON.stringify(record));
                    if (!this.editFormData.Bichikuhin) this.editFormData.Bichikuhin = { name: '' };
                },

                cancelEdit() {
                    this.editingRecordId = null;
                    this.editFormData = {};
                },

                async saveEdit() {
                    // Resolve Bichikuhin ID from name
                    let bichikuhinId = this.editFormData.BichikuhinId;
                    const originalRecord = this.records.find(r => r.id === this.editFormData.id);
                    if (this.editFormData.Bichikuhin.name !== originalRecord.Bichikuhin.name) {
                         const res = await this.apiFetch(`/api/bichikuhin?name=${this.editFormData.Bichikuhin.name}`);
                         if(res.ok) {
                            const items = await res.json();
                            const exactMatch = items.find(item => item.name === this.editFormData.Bichikuhin.name);
                            if(exactMatch) {
                                bichikuhinId = exactMatch.id;
                            } else {
                                if (!this.editFormData.Bichikuhin.name) {
                                    alert('備蓄品名は必須です。');
                                    return;
                                }
                                const newBichikuhinRes = await this.apiFetch('/api/bichikuhin', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ name: this.editFormData.Bichikuhin.name })
                                });
                                if (newBichikuhinRes.ok) {
                                    const newItem = await newBichikuhinRes.json();
                                    bichikuhinId = newItem.id;
                                } else {
                                    alert('新しい備蓄品の作成に失敗しました。');
                                    return;
                                }
                            }
                         }
                    }

                    const payload = {
                        id: this.editFormData.id,
                        bichikuhinId: bichikuhinId,
                        locationId: this.editFormData.StorageLocationId,
                        quantity: this.editFormData.quantity,
                        unitId: this.editFormData.UnitId,
                        expiryDate: this.editFormData.expiry_date,
                        stocktakingId: this.editFormData.StocktakingId
                    };
                    
                    const res = await this.apiFetch('/api/records', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (res.ok) {
                        this.cancelEdit();
                        await this.fetchData(this.selectedStocktakingId);
                    } else {
                        alert('レコードの更新に失敗しました。');
                    }
                },

                async logout() {
                    await fetch('/api/logout', { method: 'POST' });
                    window.location.href = '/login';
                },

                formatDate(dateStr, options = {}) {
                    if (!dateStr) return '';
                    const defaultOptions = { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' };
                    const mergedOptions = { ...defaultOptions, ...options };
                    return new Date(dateStr).toLocaleString('ja-JP', mergedOptions);
                },

                resetForm() {
                    const stocktakingId = this.form.stocktakingId;
                    this.form = { 
                        id: null, 
                        bichikuhinId: '', 
                        locationId: '', 
                        quantity: 0, 
                        expiryDate: '', // Reverted: No default date for new entries
                        unitId: '', 
                        stocktakingId: stocktakingId 
                    };
                    this.bichikuhinName = '';
                },

                editRecord(record) {
                    this.form.id = record.id;
                    this.form.bichikuhinId = record.BichikuhinId;
                    this.bichikuhinName = record.Bichikuhin?.name || '';
                    this.form.locationId = record.StorageLocationId;
                    this.form.quantity = record.quantity;
                    this.form.expiryDate = record.expiry_date;
                    this.form.unitId = record.UnitId;
                    this.form.stocktakingId = record.StocktakingId;
                }
            }
        }
    </script>
</body>
</html>
